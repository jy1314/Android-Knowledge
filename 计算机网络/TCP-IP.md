# TCP/IP
相信只要学过计算机网络的人都应该知道TCP/IP。TCP/IP协议（Transmission Control Protocol/Internet Protocol），包含了一系列构成互联网基础的网络协议，是Internet的核心协议。

基于TCP/IP的参考模型将协议分成了四个层次，它们分别是链路层、网络层、传输层和应用层。

TCP/IP协议族按照层次由上到下，层层包装。
最上面的是应用层，这里面有http，ftp，等等我们熟悉的协议。
第二层则是传输层，著名的TCP和UDP协议就在这个层次。
第三层是网络层，IP协议就在这里，它负责对数据加上IP地址和其他的数据以确定传输的目标。
第四层是数据链路层，这个层次为待传送的数据加入一个以太网协议头，并进行CRC编码，为最后的数据传输做准备。

TCP/IP协议通信的过程其实就对应着数据入栈与出栈的过程。入栈的过程，数据发送方每层不断地封装首部与尾部，添加一些传输的信息，确保能传输到目的地。出栈的过程，数据接收方每层不断地拆除首部与尾部，得到最终传输的数据。（如下图）

![](https://github.com/jy1314/Android-Knowledge/blob/master/util/picture/TCP-IP.jpg)

## 数据链路层

数据链路层负责将0、1序列划分为数据帧从一个节点传输到临近的另一个节点，这些节点是通过MAC地址来唯一标识的。

重要过程：
+ 封装成帧：把网络层数据报加头和尾，封装成帧，帧头中包括源MAC地址和目的MAC地址。
+ 透明传输：零比特填充、转义字符。
+ 可靠传输：在出错率很低的链路上很少用，但是无线链路WLAN会保证可靠传输。
+ 差错检测(CRC)：接收者检测错误,如果发现差错，丢弃该帧。

## 网络层
### IP协议

IP协议是TCP/IP协议的核心，所有的TCP，UDP，ICMP，IGCP的数据都以IP数据格式传输。但是，**IP不是可靠的协议**。

ip地址：

在数据链路层中我们一般通过MAC地址来识别不同的节点，而在IP层我们也要有一个类似的地址标识，这就是IP地址。ipv4地址有32位，ipv6地址有128位。尽管v6是未来必然的趋势，但目前v4仍是主流。
ipv4但32位IP地址分为**网络位**和**地址位**，划分方法有3种：
+ A类IP地址：1.0.0.0~127.0.0.0
+ B类IP地址：128.0.0.0~191.255.255.255
+ C类IP地址：192.0.0.0~223.255.255.255

实际上，还存在着D类地址和E类地址。但这两类地址用途比较特殊，在这里只是简单介绍一下：D类地址称为广播地址，供特殊协议向选定的节点发送信息时用。E类地址保留给将来使用。

IP协议头如下：

![](https://github.com/jy1314/Android-Knowledge/blob/master/util/picture/TCP-IP2.jpg)

TTL（Time To Live）这个字段规定该数据包在穿过多少个路由之后就会被抛弃。某个IP数据包每穿过一个路由器，该数据包的TTL数值就会减少1，当该数据包的TTL成为零，它就会被自动抛弃。这个字段的最大值是255，也就是说一个协议包也就在路由器里面最多穿行255次就会被抛弃了，根据系统的不同，一般是32或者是64。

### ARP及RARP协议

ARP（地址解析）协议是一种解析协议，作用是根据IP地址获取MAC地址。

ARP协议会维护一个ARP高速缓存，里面寸着MAC-IP的对应关系。主机发包时先查一下ARP高速缓存，如果没有对应的IP，那么主机会向网络内发送ARP广播。对应IP的主机在收到广播后会将自己的MAC-IP对应关系回复给请求主机，请求主机将此对应关系存入ARP高速缓存以便下一次使用。其他主机不会响应此广播。

### ICMP协议

ICMP全称网络控制报文协议。尽管ICMP是封装在IP协议中的，但ICMP不是高层协议，而是IP层的协议。

主要作用是当传送IP数据包发生错误。比如主机不可达，路由不可达等等，ICMP协议将会把错误信息封包，然后传送回给主机。


## 传输层
### TCP/UDP

TCP/UDP都是是传输层协议。

|-        | TCP     | UDP     |
|:--------|:--------|:--------|
 可靠性|可靠|不可靠
 连接性|面向连接|无连接
 报文|字节流|面向报文
 效率|低|高
 双工性|全双工|单对单、多对单、单对多、多对多
 流量控制|滑动窗口|无
 拥塞控制|慢开始、快重传、快恢复、拥塞避免|无
传输速度|慢|快

面向报文和字节流
**面向报文**的传输方式是应用层交给UDP多长的报文，UDP发送多长的报文，即一次发送一个报文。因此，应用程序必须选择合适大小的报文。若报文太长，则IP层需要分片，降低效率；若太短，会使IP数据报太小。
**字节流**则是TCP把应用程序看成是一连串的无结构的字节流。TCP有一个缓冲，当应用程序传送的数据块太长，TCP就可以把它划分短一些再传送。

由于链路层以太网帧的MTU（最大传输单元）为1500byte，网络层，因为IP包的首部要占用20字节，所以IP包的MTU为1500－20＝1480。因此，UDP包的大小就应该是 1500 - IP头(20) - UDP头(8) = 1472(Bytes)，TCP包的大小就应该是 1500 - IP头(20) - TCP头(20) = 1460 (Bytes)

什么情况下用TCP？

对通讯质量有要求的时候。例如：SMTP简单邮件传输协议、TELNET远程接入、HTTP协议、FTP文件传输协议。

什么情况下用UDP？

对通讯质量要求不高，但是要求通讯速度时。DNS域名系统、NFS远程文件服务器、SNMP网络管理等。

注：DNS（Domain Name System)是域名与地址相映射的一个分布式数据库，通过主机名，获取对应主机的IP地址（即域名解析）。端口号53，用的是UDP。

## TCP
### TCP 连接
TCP把连接作为最基本的抽象。每条TCP连接有两个确定的端点，即两个套接字。套接字socket = （IP ： 端口号）。因此，同一个端口可以出现在多个TCP连接中，同一个IP地址可以有多个TCP连接。

### TCP连接建立
著名的三次握手，相信大家都听说过。

过程如下图：

![](https://github.com/jy1314/Android-Knowledge/blob/master/util/picture/TCP1.jpg)

三次握手的目的是同步连接双方的序列号和确认号并交换**TCP窗口的大小**（用于流量控制）。

为什么要三次握手？

防止已经失效的连接请求报文又突然传送到了服务端。

### TCP连接释放
四次挥手，过程如下图：

![](https://github.com/jy1314/Android-Knowledge/blob/master/util/picture/TCP2.jpg)

为什么要四次挥手？

TCP支持全双工模式，那么主机A发送FIN报文时只是表示主机A没有要发送的数据了，主机B仍可向A发送数据，此时称为**半关闭**状态。这种状态可能会持续一段时间。之后B向A发送FIN报文，A确认，等待2MSL后连接关闭。

为什么等待2MSL？

MSL是单个报文在网络中的最大生存时间，2MSL后能保证来回的报文全部消失。
+ 防止最后A向B的确认信息丢失，B无法正常关闭连接；
+ 如果A在关闭向B的连接后又向B相同端口发起一个新的连接，如果由于网络状况的原因之前的连接关闭确认信息在连接建立请求信息之后到达，就有可能使两次TCP的数据包发生混淆。

### TCP流量控制

通俗的讲，流量控制就是让发送方发送的不要太快，以免接收方来不及接收。TCP中用滑动窗口机制来实现流量控制。

A和B在建立连接时会告知对方接收窗口的大小，发送k字节报文后发送方会将接收方的接收窗口减小k字节，如果减小到0则停止发送，进行等待，等待接收方更新发送窗口。接收方子啊发送确认信息时会通知发送方接收窗口的大小，从而达到流量控制的目的。

### TCP拥塞控制

发送方会维持一个拥塞窗口的变量，大小取决于网络环境的拥塞程度，动态变化。发送方最大的发送窗口等于拥塞窗口。如果网络没拥塞，拥塞窗口就会增大一些，有拥塞，拥塞窗口就会减小。

为了防止拥塞窗口增长过大，会设置一个慢开始门限ssthresh，cwnd<=ssthresh时用慢开始算法，cwnd>=ssthresh时用拥塞避免算法。

出现拥塞的标志：没有按时收到确认。

慢开始算法：

一开始发送数据时，先将cwnd设置的小一些，然后根据网络状况由小到大增大cwnd。一般情况下先把cwnd设置为最大报文段MMS的数值，每次扩大至多2倍，指数增长。

拥塞避免算法：

和慢开始差不多，只是cwnd每次+1，线性增长。

出现拥塞后，将慢开始门限设置为拥塞时发送窗口的一般且大于1，cwnd设为1，执行慢开始算法。这样做的目的是快速减少网络中的分组数，给拥塞的路由器足够时间处理拥塞数据。


快重传算法：

发送方一连收到3个重复确认，就立即重传接收方尚未收到的报文，而不必等待重传计时器到期。

快恢复算法：

在发送方一连收到3个重复确认时，精拥塞窗口设为慢开始门限的一半，然后执行拥塞避免算法。
