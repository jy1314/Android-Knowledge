# TCP/IP
相信只要学过计算机网络的人都应该知道TCP/IP。TCP/IP协议（Transmission Control Protocol/Internet Protocol），包含了一系列构成互联网基础的网络协议，是Internet的核心协议。

基于TCP/IP的参考模型将协议分成了四个层次，它们分别是链路层、网络层、传输层和应用层。

TCP/IP协议族按照层次由上到下，层层包装。
最上面的是应用层，这里面有http，ftp，等等我们熟悉的协议。
第二层则是传输层，著名的TCP和UDP协议就在这个层次。
第三层是网络层，IP协议就在这里，它负责对数据加上IP地址和其他的数据以确定传输的目标。
第四层是数据链路层，这个层次为待传送的数据加入一个以太网协议头，并进行CRC编码，为最后的数据传输做准备。

TCP/IP协议通信的过程其实就对应着数据入栈与出栈的过程。入栈的过程，数据发送方每层不断地封装首部与尾部，添加一些传输的信息，确保能传输到目的地。出栈的过程，数据接收方每层不断地拆除首部与尾部，得到最终传输的数据。（如下图）

![](https://github.com/jy1314/Android-Knowledge/blob/master/util/picture/TCP-IP.jpg)

## 数据链路层

数据链路层负责将0、1序列划分为数据帧从一个节点传输到临近的另一个节点，这些节点是通过MAC地址来唯一标识的。

重要过程：
+ 封装成帧：把网络层数据报加头和尾，封装成帧，帧头中包括源MAC地址和目的MAC地址。
+ 透明传输：零比特填充、转义字符。
+ 可靠传输：在出错率很低的链路上很少用，但是无线链路WLAN会保证可靠传输。
+ 差错检测(CRC)：接收者检测错误,如果发现差错，丢弃该帧。

## 网络层
### IP协议

IP协议是TCP/IP协议的核心，所有的TCP，UDP，ICMP，IGCP的数据都以IP数据格式传输。但是，**IP不是可靠的协议**。

ip地址：

在数据链路层中我们一般通过MAC地址来识别不同的节点，而在IP层我们也要有一个类似的地址标识，这就是IP地址。ipv4地址有32位，ipv6地址有128位。尽管v6是未来必然的趋势，但目前v4仍是主流。
ipv4但32位IP地址分为**网络位**和**地址位**，划分方法有3种：
+ A类IP地址：1.0.0.0~127.0.0.0
+ B类IP地址：128.0.0.0~191.255.255.255
+ C类IP地址：192.0.0.0~223.255.255.255

实际上，还存在着D类地址和E类地址。但这两类地址用途比较特殊，在这里只是简单介绍一下：D类地址称为广播地址，供特殊协议向选定的节点发送信息时用。E类地址保留给将来使用。

IP协议头如下：

![](https://github.com/jy1314/Android-Knowledge/blob/master/util/picture/TCP-IP2.jpg)

TTL（Time To Live）这个字段规定该数据包在穿过多少个路由之后就会被抛弃。某个IP数据包每穿过一个路由器，该数据包的TTL数值就会减少1，当该数据包的TTL成为零，它就会被自动抛弃。这个字段的最大值是255，也就是说一个协议包也就在路由器里面最多穿行255次就会被抛弃了，根据系统的不同，一般是32或者是64。

### ARP及RARP协议

ARP（地址解析）协议是一种解析协议，作用是根据IP地址获取MAC地址。

ARP协议会维护一个ARP高速缓存，里面寸着MAC-IP的对应关系。主机发包时先查一下ARP高速缓存，如果没有对应的IP，那么主机会向网络内发送ARP广播。对应IP的主机在收到广播后会将自己的MAC-IP对应关系回复给请求主机，请求主机将此对应关系存入ARP高速缓存以便下一次使用。其他主机不会响应此广播。

### ICMP协议

ICMP全称网络控制报文协议。ICMP不是高层协议，而是IP层的协议。

主要作用是当传送IP数据包发生错误。比如主机不可达，路由不可达等等，ICMP协议将会把错误信息封包，然后传送回给主机。


## 传输层
### TCP/UDP

TCP/UDP都是是传输层协议。

|-        | TCP     | UDP     |
|:--------|:--------|:--------|
 可靠性|可靠|不可靠
 连接性|面向连接|无连接
 报文|字节流|面向报文
 效率|低|高
 双工性|全双工|单对单、多对单、单对多、多对多
 流量控制|滑动窗口|无
 拥塞控制|慢开始、快重传、快恢复、拥塞避免|无
传输速度|慢|快

面向报文和字节流
**面向报文**的传输方式是应用层交给UDP多长的报文，UDP发送多长的报文，即一次发送一个报文。因此，应用程序必须选择合适大小的报文。若报文太长，则IP层需要分片，降低效率；若太短，会使IP数据报太小。
**字节流**则是TCP把应用程序看成是一连串的无结构的字节流。TCP有一个缓冲，当应用程序传送的数据块太长，TCP就可以把它划分短一些再传送。


